!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.typed=e()}(this,function(){"use strict";function compareTypes(t,e){return"any"===t?1:"any"===e?-1:"Object"===t?1:"Object"===e?-1:0}function merge(){for(var t={},e=0;e<arguments.length;e++){var r=arguments[e];for(var n in r)r.hasOwnProperty(n)&&(t[n]=r[n])}return t}function last(t){return t[t.length-1]}function getTypeTest(t){var e=typed.types[t];if(!e){var r=Object.keys(typed.types).filter(function(e){return e.toLowerCase()==t.toLowerCase()}).map(function(t){return'"'+t+'"'});throw new Error('Unknown type "'+t+'"'+(r.length?". Did you mean "+r.join(", or ")+"?":""))}return e}function Refs(t){this.name=t||"refs",this.categories={}}function Param(t,e){if("string"==typeof t)this.types=t.split("|").map(function(t){return t.trim()});else{if(!Array.isArray(t)){if(t instanceof Param)return t.clone();throw new Error("String or Array expected")}this.types=t}void 0!==this.types[0]&&"..."==this.types[0].substring(0,3)?(this.types[0]=this.types[0].substring(3)||"any",this.varArgs=!0):this.varArgs=e||!1,this.anyType=this.types.some(function(t){return"any"==t})}function Signature(t,e){if("string"==typeof t)this.params=""!==t?t.split(",").map(function(t){return new Param(t)}):[];else{if(!Array.isArray(t))throw new Error("string or Array expected");this.params=t.map(function(t){return new Param(t)})}var r=this.params.filter(function(t){return t.varArgs});if(0===r.length)this.varArgs=!1;else{if(r[0]!==this.params[this.params.length-1])throw new SyntaxError('Unexpected variable arguments operator "..."');this.varArgs=!0}this.fn=e}function Node(t){this.type=t,this.fn=null,this.varArgs=!1,this.childs={}}function RootNode(t){this.name=t||"",this.fn=null,this.childs={}}function parseSignatures(t){return Object.keys(t).reduce(function(e,r){var n=t[r],s=new Signature(r,n);return e.concat(s.split())},[])}function normalizeSignatures(t){var e={};return t.map(function(t){var r=t.params.join(",");if(r in e)throw new Error('Error: signature "'+r+'" defined twice');e[r]=t.fn}),e}function parseTree(t,e){var r=new RootNode(t);return e.forEach(function(t){for(var e=t.params.concat([]),n=r;e.length>0;){var s=e.shift(),i=s.toString(),o=n.childs[i];void 0===o&&(o=n.childs[i]=new Node(s)),n=o}n.fn=t.fn,n.varArgs=t.varArgs}),r}function minify(t){return t.replace(/\/\/.*/g,"").replace(/\s*\n\s*/gm,"").replace(/\s?([{}()=<>;,]+)\s?/g,function(t,e){return e}).replace(/(signature|test|convert|arg)(?=\d)|varArgs|match/g,function(t){return t.charAt(0)})}function _typed(name,signatures){var refs=new Refs,_signatures=parseSignatures(signatures),tree=parseTree(name,_signatures),treeCode=tree.toCode(refs),refsCode=refs.toCode(),factory=["(function ("+refs.name+") {",refsCode,treeCode,"})"].join("\n");typed.config.minify&&(factory=minify(factory));var fn=eval(factory)(refs);return console.log("FN\n"+fn.toString()),fn.signatures=normalizeSignatures(_signatures),fn}Refs.prototype.add=function(t,e){var r=e||"fn";this.categories[r]||(this.categories[r]=[]);var n=this.categories[r].indexOf(t);return-1==n&&(n=this.categories[r].length,this.categories[r].push(t)),r+n},Refs.prototype.toCode=function(){var t=[],e=this.name+".categories",r=this.categories;return Object.keys(r).forEach(function(n){r[n].forEach(function(r,s){t.push("var "+n+s+" = "+e+"['"+n+"']["+s+"];")})}),t.join("\n")},Param.prototype.clone=function(){return new Param(this.types.slice(),this.varArgs)},Param.prototype.toString=function(){return(this.varArgs?"...":"")+this.types.join("|")},Signature.prototype.split=function(){function t(r,n,s){if(s<r.params.length){var i=r.params[s];s==r.params.length-1&&r.varArgs?t(r,n.concat(i),s+1):i.types.forEach(function(e){t(r,n.concat(new Param(e,i.varArgs)),s+1)})}else e.push(new Signature(n,r.fn))}var e=[];return t(this,[],0),e},Node.prototype.depth=function(){var t=0;return Object.keys(this.childs).forEach(function(e){var r=this.childs[e].depth()+1;t=Math.max(t,r)}.bind(this)),t},Node.prototype._toCode=function(t,e){var r,n,s,i=[],o=t.prefix,a=this.fn?t.refs.add(this.fn,"signature"):void 0,u=this.varArgs?"varArgs":"arg"+t.args.length,p=this.type;e?(r=t.refs.add(getTypeTest(e.from),"test"),s=t.refs.add(e.convert,"convert"),n=p.varArgs===!1?s+"("+u+")":u):(r=p.anyType===!1?t.refs.add(getTypeTest(p.types[0]),"test"):"",s=null,n=u);var f="// type: "+(s?e.from+", convert to "+p:p),h=t.args.concat(n),c=t.types.concat(p),g=t.tests.concat(r),y=merge(t,{args:h,types:c,tests:g});if(this.varArgs){if(p.anyType)a&&(i.push(o+"if (arguments.length >= "+h.length+") {"),i.push(o+"  var varArgs = [];"),i.push(o+"  for (var i = "+(h.length-1)+"; i < arguments.length; i++) {"),i.push(o+"    varArgs.push(arguments[i]);"),i.push(o+"  }"),i.push(o+"  return "+a+"("+h.join(", ")+"); // signature: "+c.join(", ")),i.push(o+"}"));else if(a){var d=p.types.map(function(e){var r=t.refs.add(getTypeTest(e),"test");return r+"(arguments[i])"}).join(" || ");i.push(o+"if (arguments.length >= "+h.length+") {"),i.push(o+"  var match = true;"),i.push(o+"  var varArgs = [];"),i.push(o+"  for (var i = "+(h.length-1)+"; i < arguments.length; i++) {"),i.push(o+"    if ("+d+") { // type: "+p.types.join(" or ")),i.push(o+"      varArgs.push(arguments[i]);"),t.conversions&&this._getVarArgConversions().forEach(function(e){var r=t.refs.add(getTypeTest(e.from),"test"),n=t.refs.add(e.convert,"convert"),s="// type: "+e.from+", convert to "+e.to;i.push(o+"    }"),i.push(o+"    else if ("+r+"(arguments[i])) { "+s),i.push(o+"      varArgs.push("+n+"(arguments[i]));")}.bind(this)),i.push(o+"    } else {"),i.push(o+"      match = false;"),i.push(o+"      break;"),i.push(o+"    }"),i.push(o+"  }"),i.push(o+"  if (match) {"),i.push(o+"    return "+a+"("+h.join(", ")+"); // signature: "+c.join(", ")),i.push(o+"  }"),i.push(o+"}")}}else p.anyType?i.push(this._innerCode(y)):(i.push(o+"if ("+r+"("+u+")) { "+f),i.push(this._innerCode(merge(y,{prefix:o+"  "}))),i.push(o+"}"));return i.join("\n")},Node.prototype._innerCode=function(t){var e=[],r=t.prefix,n=this.fn?t.refs.add(this.fn,"signature"):void 0;if(n&&(e.push(r+"if (arguments.length === "+t.args.length+") {"),e.push(r+"  return "+n+"("+t.args.join(", ")+"); // signature: "+t.types.join(", ")),e.push(r+"}")),this._getChilds().forEach(function(r){e.push(r._toCode(merge(t)))}),t.conversions){var s=this._conversionsToCode(t);s.length>0&&e.push(s)}return t.exceptions,e.join("\n")},Node.prototype._conversionsToCode=function(t){var e=[];return this._getConversions().forEach(function(r){var n=r.to,s=this.childs[n];e.push(s._toCode(t,r))}.bind(this)),e.join("\n")},Node.prototype._getChilds=function(){return Object.keys(this.childs).sort(compareTypes).map(function(t){return this.childs[t]}.bind(this))},Node.prototype._getConversions=function(){var t={};return typed.conversions.filter(function(e){return void 0!==this.childs[e.from]||void 0===this.childs[e.to]||t[e.from]?!1:(t[e.from]=!0,!0)}.bind(this))},Node.prototype._getVarArgConversions=function(){var t={};return typed.conversions.filter(function(e){return-1!==this.type.types.indexOf(e.from)||-1===this.type.types.indexOf(e.to)||t[e.from]?!1:(t[e.from]=!0,!0)}.bind(this))},Node.prototype.hasVarArgs=function(){for(var t in this.childs)if(this.childs.hasOwnProperty(t)&&this.childs[t].type.varArgs)return!0;return!1},RootNode.prototype=Object.create(Node.prototype),RootNode.prototype.toCode=function(t){for(var e=[],r=this.depth(),n=[],s=0;r>s;s++)n[s]="arg"+s;var i=typed.conversions.length>0;e.push("return function "+this.name+"("+n.join(", ")+") {");var o=this.fn?t.add(this.fn,"signature"):void 0;o&&(e.push("  if (arguments.length === 0) {"),e.push("    return "+o+"(); // signature: (empty)"),e.push("  }"));var a={refs:t,args:[],types:[],tests:[],prefix:"  "};return i?(e.push("  // exactly matching signatures"),this._getChilds().forEach(function(t){e.push(t._toCode(merge(a,{conversions:!1,exceptions:!1})))}),e.push("  // convert into matching signatures"),this._getChilds().forEach(function(t){e.push(t._toCode(merge(a,{conversions:!0,exceptions:!0})))}),this.hasVarArgs()||e.push(this._conversionsToCode(merge(a,{conversions:!0,exceptions:!0})))):(e.push("  // exactly matching signatures"),this._getChilds().forEach(function(t){e.push(t._toCode(merge(a,{conversions:!1,exceptions:!0})))})),e.push("  throw new TypeError('Wrong function signature');"),e.push("}"),e.join("\n")};var types={"null":function(t){return null===t},"boolean":function(t){return"boolean"==typeof t},number:function(t){return"number"==typeof t},string:function(t){return"string"==typeof t},"function":function(t){return"function"==typeof t},Array:function(t){return Array.isArray(t)},Date:function(t){return t instanceof Date},RegExp:function(t){return t instanceof RegExp},Object:function(t){return"object"==typeof t}},config={minify:!0},conversions=[],typed={config:config,types:types,conversions:conversions};return typed=_typed("typed",{Object:function(t){return _typed(null,t)},"string, Object":_typed,"string, function":function(t,e){var r={};return r[t]=e,_typed(null,r)},"string, string, function":function(t,e,r){var n={};return n[e]=r,_typed(t,n)}}),typed.config=config,typed.types=types,typed.conversions=conversions,typed});